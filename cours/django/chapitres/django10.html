<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Chapitre 10 - Authentification et s√©curit√©</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      background: #f4f4f4;
      color: #333;
    }
    header {
      background-color: #092e20;
      color: white;
      padding: 2rem;
      text-align: center;
    }
    main {
      max-width: 800px;
      margin: 2rem auto;
      padding: 2rem;
      background: white;
      border-radius: 10px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    h1, h2 {
      color: #092e20;
    }
    pre {
      background: #eee;
      padding: 1rem;
      border-radius: 5px;
      overflow-x: auto;
    }
    .btn {
      display: inline-block;
      margin-top: 2rem;
      padding: 0.8rem 1.5rem;
      background-color: #092e20;
      color: white;
      text-decoration: none;
      border-radius: 8px;
    }
    footer {
      text-align: center;
      padding: 2rem;
      font-size: 0.9rem;
    }
    a {
      color: #092e20;
      text-decoration: none;
    }
    a:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <header>
    <h1>Chapitre 10 : Authentification et s√©curit√© üîê</h1>
    <p>Apprends √† impl√©menter l‚Äôauthentification des utilisateurs et √† s√©curiser ton application Django contre les attaques courantes.</p>
  </header>

  <main>
    <h2>üîπ Pourquoi l‚Äôauthentification et la s√©curit√© ?</h2>
    <p>L‚Äôauthentification permet de v√©rifier l‚Äôidentit√© des utilisateurs (inscription, connexion, d√©connexion) et de restreindre l‚Äôacc√®s √† certaines fonctionnalit√©s. La s√©curit√© prot√®ge contre des menaces comme les attaques CSRF, XSS, ou les injections SQL, garantissant la fiabilit√© et la confidentialit√© des donn√©es.</p>
    <p><strong>Fonctionnalit√©s cl√©s de Django :</strong></p>
    <ul>
      <li><strong>Authentification int√©gr√©e</strong>: Module <code>django.contrib.auth</code> pour g√©rer les utilisateurs, sessions, et permissions.</li>
      <li><strong>Vues pr√™tes √† l‚Äôemploi</strong>: Connexion, d√©connexion, et r√©initialisation de mot de passe via <code>django.contrib.auth.views</code>.</li>
      <li><strong>Protection CSRF</strong>: Token automatique pour s√©curiser les formulaires.</li>
      <li><strong>√âchappement XSS</strong>: Templates Django √©chappent les donn√©es par d√©faut.</li>
      <li><strong>Hachage des mots de passe</strong>: Stockage s√©curis√© avec PBKDF2/SHA256.</li>
    </ul>

    <h2>üîπ Exemple 1 : Configurer l‚Äôauthentification int√©gr√©e</h2>
    <p>Django inclut l‚Äôauthentification par d√©faut. V√©rifie que <code>django.contrib.auth</code> est dans <code>INSTALLED_APPS</code> (<code>monprojet/settings.py</code>):</p>
    <pre><code>
INSTALLED_APPS = [
    'django.contrib.admin',
    'django.contrib.auth',  # Authentification
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.staticfiles',
    'blog.apps.BlogConfig',
]
    </code></pre>
    <p>Ajoute les URLs d‚Äôauthentification dans <code>monprojet/urls.py</code>:</p>
    <pre><code>
from django.contrib import admin
from django.urls import path, include

urlpatterns = [
    path('admin/', admin.site.urls),
    path('accounts/', include('django.contrib.auth.urls')),  # URLs d‚Äôauth
    path('blog/', include('blog.urls')),
]
    </code></pre>
    <p><strong>Explication</strong>:</p>
    <ul>
      <li><code>django.contrib.auth.urls</code>: Fournit des URLs comme <code>/accounts/login/</code>, <code>/accounts/logout/</code>, <code>/accounts/password_change/</code>.</li>
      <li>Les vues associ√©es utilisent des templates par d√©faut que nous personnaliserons.</li>
    </ul>
    <p><strong>R√©sultat</strong>: Acc√®de √† <code>/accounts/login/</code>. Sans template personnalis√©, une erreur <code>TemplateDoesNotExist</code> peut appara√Ætre (corrig√© dans l‚Äôexemple suivant).</p>

    <h2>üîπ Exemple 2 : Cr√©er des templates pour l‚Äôauthentification</h2>
    <p>Cr√©e <code>templates/registration/login.html</code> dans le dossier racine du projet (√† c√¥t√© de <code>manage.py</code>):</p>
    <pre><code>
{% extends 'base.html' %}

{% block title %}Connexion{% endblock %}
{% block content %}
<h1>Connexion</h1>
<form method="post">
    {% csrf_token %}
    {{ form.as_p }}
    <button type="submit">Se connecter</button>
</form>
<p><a href="{% url 'password_reset' %}">Mot de passe oubli√© ?</a></p>
{% endblock %}
    </code></pre>
    <p>Assure-toi que <code>base.html</code> existe (voir chapitre 6) ou cr√©e un fichier minimal:</p>
    <pre><code>
<!DOCTYPE html>
<html>
<head>
    <title>{% block title %}Mon Blog{% endblock %}</title>
</head>
<body>
    {% block content %}
    {% endblock %}
</body>
</html>
    </code></pre>
    <p>Configure <code>settings.py</code> pour indiquer o√π trouver les templates:</p>
    <pre><code>
TEMPLATES = [
    {
        'BACKEND': 'django.template.backends.django.DjangoTemplates',
        'DIRS': [BASE_DIR / 'templates'],  # Dossier templates
        'APP_DIRS': True,
        ...
    },
]
    </code></pre>
    <p><strong>Explication</strong>:</p>
    <ul>
      <li><code>{% csrf_token %}</code>: Prot√®ge le formulaire contre les attaques CSRF.</li>
      <li><code>{{ form.as_p }}</code>: Affiche le formulaire de connexion (email/mot de passe).</li>
      <li><code>{% url 'password_reset' %}</code>: Lien vers la r√©initialisation du mot de passe.</li>
    </ul>
    <p><strong>R√©sultat</strong>: <code>/accounts/login/</code> affiche un formulaire de connexion fonctionnel. Cr√©e un utilisateur via <code>python manage.py createsuperuser</code> pour tester.</p>

    <h2>üîπ Exemple 3 : Prot√©ger une vue avec @login_required</h2>
    <p>Cr√©e une vue prot√©g√©e dans <code>blog/views.py</code>:</p>
    <pre><code>
from django.contrib.auth.decorators import login_required
from django.shortcuts import render

@login_required
def dashboard(request):
    return render(request, 'blog/dashboard.html', {'user': request.user})
    </code></pre>
    <p>Cr√©e <code>blog/templates/blog/dashboard.html</code>:</p>
    <pre><code>
{% extends 'base.html' %}

{% block title %}Tableau de bord{% endblock %}
{% block content %}
<h1>Tableau de bord</h1>
<p>Bienvenue, {{ user.username }} !</p>
<p>Email : {{ user.email }}</p>
<a href="{% url 'logout' %}">Se d√©connecter</a>
{% endblock %}
    </code></pre>
    <p>Ajoute l‚ÄôURL dans <code>blog/urls.py</code>:</p>
    <pre><code>
from django.urls import path
from . import views

urlpatterns = [
    path('dashboard/', views.dashboard, name='dashboard'),
    # Autres URLs
]
    </code></pre>
    <p>Configure la redirection apr√®s connexion dans <code>settings.py</code>:</p>
    <pre><code>
LOGIN_REDIRECT_URL = '/blog/dashboard/'
LOGOUT_REDIRECT_URL = '/accounts/login/'
    </code></pre>
    <p><strong>Explication</strong>:</p>
    <ul>
      <li><code>@login_required</code>: Restreint l‚Äôacc√®s aux utilisateurs connect√©s, sinon redirige vers <code>/accounts/login/</code>.</li>
      <li><code>request.user</code>: Fournit les informations de l‚Äôutilisateur connect√©.</li>
      <li><code>LOGIN_REDIRECT_URL</code>: D√©finit o√π aller apr√®s connexion.</li>
    </ul>
    <p><strong>R√©sultat</strong>: <code>/blog/dashboard/</code> est accessible uniquement apr√®s connexion et affiche les informations de l‚Äôutilisateur.</p>

    <h2>üîπ Exemple 4 : Inscription personnalis√©e</h2>
    <p>Cr√©e un formulaire d‚Äôinscription dans <code>blog/forms.py</code>:</p>
    <pre><code>
from django import forms
from django.contrib.auth.models import User
from django.contrib.auth.forms import UserCreationForm

class InscriptionForm(UserCreationForm):
    email = forms.EmailField(required=True)

    class Meta:
        model = User
        fields = ['username', 'email', 'password1', 'password2']

    def save(self, commit=True):
        user = super().save(commit=False)
        user.email = self.cleaned_data['email']
        if commit:
            user.save()
        return user
    </code></pre>
    <p>Cr√©e une vue dans <code>blog/views.py</code>:</p>
    <pre><code>
from django.shortcuts import render, redirect
from .forms import InscriptionForm

def inscription(request):
    if request.method == 'POST':
        form = InscriptionForm(request.POST)
        if form.is_valid():
            form.save()
            return redirect('login')
    else:
        form = InscriptionForm()
    return render(request, 'registration/inscription.html', {'form': form})
    </code></pre>
    <p>Cr√©e <code>templates/registration/inscription.html</code>:</p>
    <pre><code>
{% extends 'base.html' %}

{% block title %}Inscription{% endblock %}
{% block content %}
<h1>Inscription</h1>
<form method="post">
    {% csrf_token %}
    {{ form.as_p }}
    <button type="submit">S‚Äôinscrire</button>
</form>
<p>D√©j√† un compte ? <a href="{% url 'login' %}">Se connecter</a></p>
{% endblock %}
    </code></pre>
    <p>Ajoute l‚ÄôURL dans <code>blog/urls.py</code>:</p>
    <pre><code>
urlpatterns = [
    path('inscription/', views.inscription, name='inscription'),
    # Autres URLs
]
    </code></pre>
    <p><strong>Explication</strong>:</p>
    <ul>
      <li><code>UserCreationForm</code>: Fournit les champs pour le nom d‚Äôutilisateur et le mot de passe.</li>
      <li><code>email</code>: Champ ajout√© pour collecter l‚Äôemail.</li>
      <li>Redirection vers <code>login</code> apr√®s inscription.</li>
    </ul>
    <p><strong>R√©sultat</strong>: <code>/blog/inscription/</code> permet de cr√©er un nouvel utilisateur.</p>

    <h2>üîπ Exemple 5 : S√©curiser les formulaires et g√©rer les permissions</h2>
    <p>Cr√©e une vue r√©serv√©e aux utilisateurs ayant une permission sp√©cifique dans <code>blog/views.py</code>:</p>
    <pre><code>
from django.contrib.auth.decorators import permission_required

@permission_required('blog.add_article')
def ajouter_article_restreint(request):
    return render(request, 'blog/ajouter_article.html')
    </code></pre>
    <p>Ajoute l‚ÄôURL dans <code>blog/urls.py</code>:</p>
    <pre><code>
urlpatterns = [
    path('articles/ajouter-restreint/', views.ajouter_article_restreint, name='ajouter_article_restreint'),
]
    </code></pre>
    <p>Attribue la permission via l‚Äôadmin (<code>/admin/</code>):</p>
    <ol>
      <li>Connecte-toi en tant que superutilisateur.</li>
      <li>Va dans <code>Utilisateurs</code>, s√©lectionne un utilisateur, et ajoute la permission <code>blog | article | Can add article</code>.</li>
    </ol>
    <p><strong>Explication</strong>:</p>
    <ul>
      <li><code>@permission_required</code>: Restreint l‚Äôacc√®s aux utilisateurs ayant la permission sp√©cifi√©e.</li>
      <li>Les permissions sont g√©n√©r√©es automatiquement pour chaque mod√®le (ex. <code>add_article</code>, <code>change_article</code>).</li>
    </ul>
    <p><strong>R√©sultat</strong>: Seuls les utilisateurs avec la permission <code>blog.add_article</code> acc√®dent √† <code>/blog/articles/ajouter-restreint/</code>.</p>

    <h2>üîπ Mesures de s√©curit√© int√©gr√©es</h2>
    <p>Django offre plusieurs protections par d√©faut:</p>
    <ul>
      <li><strong>CSRF</strong>: Tous les formulaires POST n√©cessitent <code>{% csrf_token %}</code>.</li>
      <li><strong>XSS</strong>: Les templates √©chappent automatiquement les donn√©es avec <code>{{ }}</code> (utilise <code>{{ variable|safe }}</code> avec pr√©caution).</li>
      <li><strong>Injection SQL</strong>: L‚ÄôORM utilise des requ√™tes param√©tr√©es.</li>
      <li><strong>Hachage des mots de passe</strong>: Les mots de passe sont hach√©s avec PBKDF2/SHA256.</li>
      <li><strong>Sessions s√©curis√©es</strong>: Les sessions sont g√©r√©es via des cookies s√©curis√©s.</li>
    </ul>
    <p><strong>Exemple de configuration s√©curis√©e</strong> dans <code>settings.py</code>:</p>
    <pre><code>
# Activer HTTPS pour les cookies de session
SESSION_COOKIE_SECURE = True
CSRF_COOKIE_SECURE = True

# Limiter les h√¥tes autoris√©s
ALLOWED_HOSTS = ['localhost', '127.0.0.1', 'mon-domaine.com']
    </code></pre>
    <p><strong>R√©sultat</strong>: Renforce la s√©curit√© des sessions et des formulaires.</p>

    <h2>üîπ Erreurs courantes √† √©viter</h2>
    <ul>
      <li><strong>Oubli de <code>{% csrf_token %}</code></strong>: Les formulaires POST √©choueront avec une erreur 403.</li>
      <li><strong>Template manquant</strong>: Cr√©e les templates dans <code>templates/registration/</code> pour les vues d‚Äôauthentification.</li>
      <li><strong>Utilisateur non authentifi√©</strong>: V√©rifie que <code>request.user.is_authenticated</code> est utilis√© pour les vues prot√©g√©es.</li>
      <li><strong>Permissions mal configur√©es</strong>: Utilise l‚Äôadmin pour assigner les permissions correctement.</li>
    </ul>

    <h2>üìù Exercice</h2>
    <p>1. Configure les URLs d‚Äôauthentification avec <code>django.contrib.auth.urls</code> et cr√©e un template pour <code>/accounts/login/</code>.<br>
    2. Cr√©e un superutilisateur et teste la connexion.<br>
    3. Cr√©e une vue prot√©g√©e <code>/blog/profil/</code> qui affiche le nom et l‚Äôemail de l‚Äôutilisateur connect√©.<br>
    4. Impl√©mente une page d‚Äôinscription √† <code>/blog/inscription/</code> avec un formulaire personnalis√©.<br>
    5. Cr√©e une vue <code>/blog/articles/prive/</code> accessible uniquement aux utilisateurs avec la permission <code>blog.add_article</code>.<br>
    6. Ajoute <code>SESSION_COOKIE_SECURE = True</code> dans <code>settings.py</code> et explique son effet dans un fichier texte.</p>

    <a href="../index.html" class="btn">‚Ü©Ô∏è Retour au sommaire</a>
  </main>

  <footer>
    <p><a href="../index.html">‚Üê Retour au menu Django</a></p>
  </footer>
</body>
</html>